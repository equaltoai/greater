import{a as v,c as h,g as D}from"./CR55hjPZ.js";import{a as z,l as H}from"./C2zQ9FVj.js";import{D as f}from"./BwIUDySL.js";let q=(e={})=>{let t=v(e);return t.setKey=function(n,r){let i=t.value;typeof r>"u"&&n in t.value?(t.value={...t.value},delete t.value[n],t.notify(i,n)):t.value[n]!==r&&(t.value={...t.value,[n]:r},t.notify(i,n))},t};function y(...e){for(const t of e)if(typeof t=="boolean")return t}function K(e){return y(e?.userInteractions?.liked,e?.viewerInteractions?.liked,e?.viewerState?.liked,e?.favourited,e?.favorited,e?.liked)??!1}function B(e){return y(e?.userInteractions?.shared,e?.viewerInteractions?.shared,e?.viewerState?.shared,e?.reblogged,e?.shared)??!1}function Q(e){return y(e?.userInteractions?.bookmarked,e?.viewerInteractions?.bookmarked,e?.viewerState?.bookmarked,e?.bookmarked)??!1}function V(e){return y(e?.userInteractions?.pinned,e?.viewerInteractions?.pinned,e?.viewerState?.pinned,e?.pinned)??!1}function S(e){const t=(e.attachment??[]).filter(o=>o.type==="PropertyValue"),n=Array.isArray(e.fields)&&e.fields.length>0?e.fields.map(o=>({name:o.name??"",value:o.value??"",verified_at:o.verifiedAt??null})):t.map(o=>({name:o.name??"",value:o.value??"",verified_at:null})),r=e.icon?.url??e.avatar??"",i=e.image?.url??e.header??"",p=e.webfinger??e.acct??(e.domain&&e.username?`${e.username}@${e.domain}`:void 0)??e.preferredUsername??e.username??e.id,g=typeof e.statusesCount=="number"?e.statusesCount:_(e.outbox);return{id:e.id,username:e.preferredUsername??e.username??e.id,acct:p,display_name:e.name??e.displayName??e.preferredUsername??e.username??"",locked:e.manuallyApprovesFollowers??e.locked??!1,bot:e.type==="Service"||e.bot===!0,discoverable:e.discoverable??!0,group:e.type==="Group",created_at:e.published??e.createdAt??new Date().toISOString(),note:e.summary??"",url:e.url??e.id,avatar:r,avatar_static:r,header:i,header_static:i,followers_count:_(e.followers),following_count:_(e.following),statuses_count:g,last_status_at:null,emojis:[],fields:n}}function _(e){return typeof e=="number"?e:e?.totalCount??0}const C={IMAGE:"image",VIDEO:"video",AUDIO:"audio",GIFV:"gifv",DOCUMENT:"unknown",UNKNOWN:"unknown"};function X(e,t=void 0){if(!e)return{id:"",type:"unknown",url:"",preview_url:"",remote_url:null,description:null,blurhash:null,meta:t?.length?{warnings:[...t]}:void 0};const n=e,r=n.preview_url??void 0,i=n.remote_url??void 0,p=n.text_url??void 0,g=n.spoiler_text??void 0,o=typeof e.url=="string"?e.url:"",G=(typeof e.previewUrl=="string"&&e.previewUrl.length>0?e.previewUrl:r)||o,E=Y(e.mediaCategory??e.type,e.mimeType),W=C[E]??"unknown",u=typeof e.width=="number"?e.width:null,c=typeof e.height=="number"?e.height:null,N=typeof e.duration=="number"?e.duration:null,O=u!==null||c!==null||N!==null?{width:u??0,height:c??0,size:u&&c?`${u}x${c}`:void 0,aspect:u&&c?u/c:void 0,duration:N??void 0}:void 0,s={};return O&&(s.original=O),s.media_category=E,e.mimeType&&(s.mime_type=e.mimeType),typeof e.type=="string"&&(s.media_type=e.type),t&&t.length>0&&(s.warnings=[...t]),{id:typeof e.id=="string"&&e.id.length>0?e.id:o||`upload-${Date.now()}`,type:W,url:o,preview_url:G||o,remote_url:i??e.remoteUrl??(o||null),text_url:p??e.textUrl??(o||void 0),meta:Object.keys(s).length>0?s:void 0,description:e.description??null,blurhash:e.blurhash??null,sensitive:typeof e.sensitive=="boolean"?e.sensitive:void 0,spoiler_text:e.spoilerText??g??null}}function Y(e,t){const n=typeof e=="string"?e.toUpperCase():null;return n&&C[n]?n:t?J(t)??"UNKNOWN":"UNKNOWN"}function J(e){if(!e)return null;const t=e.toLowerCase();return t.startsWith("image/")?t==="image/gif"?"GIFV":"IMAGE":t.startsWith("video/")?"VIDEO":t.startsWith("audio/")?"AUDIO":t==="application/pdf"||t==="text/plain"||t==="text/markdown"?"DOCUMENT":null}const Z={ALLOWED_TAGS:["p","br","span","a","strong","em","b","i","u","s","del","blockquote","pre","code","ul","ol","li","h1","h2","h3","h4","h5","h6","mention","hashtag"],ALLOWED_ATTR:["href","rel","target","class","title","data-user","data-tag"],ADD_ATTR:["target","rel"],FORBID_TAGS:["script","style","iframe","object","embed","form"],FORBID_ATTR:["onerror","onload","onclick","onmouseover","onfocus","onblur"]},j=/^(?:(?:(?:f|ht)tps?|mailto|tel|callto|cid|xmpp|xxx):|[^a-z]|[a-z+.\-]+(?:[^a-z+.\-:]|$))/i,ee={amp:"&",lt:"<",gt:">",quot:'"',"#x27":"'","#39":"'"},te=/&(?:amp|lt|gt|quot|#x27|#39);/gi,ne=/<[^>]*>/g;function w(e){return e.replace(te,t=>{const n=t.slice(1,-1).toLowerCase();return ee[n]??t})}function L(e){let t=e,n;do n=t,t=t.replace(ne,"");while(t!==n);return t}let l=typeof window>"u"?f:null,k=typeof window>"u"?Promise.resolve(f):null;typeof window<"u"&&A();function T(e){return e!==null&&e!==!1}function A(){typeof window>"u"||k||(l=f,k=Promise.resolve(f))}function re(){return T(l)?l:f}function I(e,t,n){const r=w(t);return e.sanitize(r,{...n,KEEP_CONTENT:!0})}function oe(e){if(typeof document>"u")return e;const t=document.createElement("div");return t.innerHTML=e,t.querySelectorAll("a").forEach(n=>{n.setAttribute("target","_blank"),n.setAttribute("rel","noopener noreferrer ugc");const r=n.getAttribute("href");r&&!r.startsWith("/")&&!r.startsWith("#")&&n.classList.add("external-link")}),t.querySelectorAll(".mention").forEach(n=>{n.setAttribute("rel","noopener noreferrer ugc")}),t.innerHTML}function fe(e){if(!e)return"";const t={...Z,ALLOWED_URI_REGEXP:j};if(typeof window>"u")return I(re(),e,t);if(T(l)){const n=I(l,e,t);return oe(n)}return A(),L(w(e))}function m(e){if(!e)return"";const t=w(e),n=T(l)?l:typeof window>"u"?f:null;return n?n.sanitize(t,{ALLOWED_TAGS:[],ALLOWED_ATTR:[],KEEP_CONTENT:!0}):(A(),L(t))}const M=()=>typeof window<"u"&&typeof window.Notification=="function",a=q({}),U=v(!0),P=v(null),x=v("all"),ie=h([a],e=>Object.values(e).length);h([a,x],(e,t)=>{let n=Object.values(e);return t!=="all"&&(n=n.filter(r=>r.type===t)),n.sort((r,i)=>new Date(i.created_at).getTime()-new Date(r.created_at).getTime())});h([a],e=>{const t={all:0,mention:0,status:0,reblog:0,follow:0,follow_request:0,favourite:0,poll:0,update:0,"admin.sign_up":0,"admin.report":0};return Object.values(e).forEach(n=>{t.all++;const r=n.type;t[r]!==void 0&&t[r]++}),t});function ae(e){const t=e.notification||e,r={MENTION:"mention",LIKE:"favourite",SHARE:"reblog",FOLLOW:"follow",FOLLOW_REQUEST:"follow_request",POLL:"poll",STATUS:"status",UPDATE:"update",ADMIN_SIGN_UP:"admin.sign_up",ADMIN_REPORT:"admin.report"}[t.type]||"mention",i=S((t.actor||t.account)??{id:t.id}),p=t.object?R(t.object):null;return{id:t.id,type:r,created_at:t.createdAt||t.created_at||new Date().toISOString(),account:i,status:p||void 0}}function R(e){return{id:e.id,uri:e.id,url:e.id,created_at:e.published||e.createdAt||new Date().toISOString(),account:S((e.actor||e.attributedTo||e.author)??{id:e.id}),content:e.content||"",visibility:e.visibility?.toLowerCase()||"public",sensitive:e.sensitive??!1,spoiler_text:e.summary??e.spoilerText??"",media_attachments:(e.attachments||[]).map(t=>X(t)),mentions:[],tags:[],emojis:[],reblogs_count:e.shares?.totalCount||e.sharesCount||0,favourites_count:e.likes?.totalCount||e.likesCount||0,replies_count:e.replies?.totalCount||e.repliesCount||0,reblogged:B(e),favourited:K(e),bookmarked:Q(e),pinned:V(e),reblog:e.shareOf?R(e.shareOf):null,in_reply_to_id:e.inReplyTo?.id||null,in_reply_to_account_id:null,application:null,language:e.language||null,muted:!1,poll:null,card:null,edited_at:e.updated||null}}async function F(e){try{await(await D()).dismissNotification(e);const n={...a.get()};delete n[e],a.set(n)}catch(t){console.error("Failed to dismiss notification:",t)}}let d=null;async function $(){if(d||!z.currentUser)return;d=(await D()).subscribeToNotificationStream().subscribe({next:t=>{try{const n=t.data?.notificationStream;if(!n)return;switch(n.type){case"NEW":if(n.notification){const r=ae(n.notification);a.set({...a.get(),[r.id]:r}),M()&&window.Notification.permission==="granted"&&se(r)}break;case"DELETE":n.notificationId&&F(n.notificationId);break}}catch(n){console.error("Failed to parse notification event:",n)}},error:t=>{console.error("Notification stream error:",t),b(),setTimeout(()=>$(),5e3)},complete:()=>{H("Notification stream closed"),d=null}})}function b(){d&&(d.unsubscribe(),d=null)}function se(e){if(!M())return;let t="",n="",r=e.account?.avatar;switch(e.type){case"mention":t=`${e.account.display_name||e.account.username} mentioned you`,n=e.status?.content?m(e.status.content):"";break;case"reblog":t=`${e.account.display_name||e.account.username} boosted your post`,n=e.status?.content?m(e.status.content):"";break;case"favourite":t=`${e.account.display_name||e.account.username} favorited your post`,n=e.status?.content?m(e.status.content):"";break;case"follow":t=`${e.account.display_name||e.account.username} followed you`,n=`@${e.account.acct}`;break;case"follow_request":t=`${e.account.display_name||e.account.username} requested to follow you`,n=`@${e.account.acct}`;break;case"poll":t="A poll you voted in has ended",n=e.status?.content?m(e.status.content):"";break;case"update":t="A post you interacted with was edited",n=e.status?.content?m(e.status.content):"";break}t&&new window.Notification(t,{body:n.length>100?n.substring(0,100)+"...":n,icon:r,tag:e.id,data:{notificationId:e.id}})}function le(){b(),a.set({}),P.set(null),U.set(!0)}const pe=Object.freeze(Object.defineProperty({__proto__:null,cleanupNotifications:le,dismissNotification:F,endCursor$:P,hasMoreNotifications$:U,notificationFilter$:x,notifications$:a,startNotificationStream:$,stopNotificationStream:b,unreadCount$:ie},Symbol.toStringTag,{value:"Module"}));export{Q as a,K as b,B as c,X as d,fe as e,S as m,pe as n,V as r,$ as s,ie as u};
