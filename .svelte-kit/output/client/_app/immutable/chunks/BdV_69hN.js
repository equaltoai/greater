import{a as g,c as b,g as h}from"./D3HftPX2.js";import{a as K,b as B}from"./DLudcOmY.js";import"./DIpZa-rG.js";import{D as m}from"./DQIc1P_2.js";let Q=(e={})=>{let t=g(e);return t.setKey=function(n,o){let i=t.value;typeof o>"u"&&n in t.value?(t.value={...t.value},delete t.value[n],t.notify(i,n)):t.value[n]!==o&&(t.value={...t.value,[n]:o},t.notify(i,n))},t};function _(...e){for(const t of e)if(typeof t=="boolean")return t}function V(e){return _(e?.userInteractions?.liked,e?.viewerInteractions?.liked,e?.viewerState?.liked,e?.favourited,e?.favorited,e?.liked)??!1}function X(e){return _(e?.userInteractions?.shared,e?.viewerInteractions?.shared,e?.viewerState?.shared,e?.reblogged,e?.shared)??!1}function Y(e){return _(e?.userInteractions?.bookmarked,e?.viewerInteractions?.bookmarked,e?.viewerState?.bookmarked,e?.bookmarked)??!1}function J(e){return _(e?.userInteractions?.pinned,e?.viewerInteractions?.pinned,e?.viewerState?.pinned,e?.pinned)??!1}function P(e){const t=(e.attachment??[]).filter(r=>r.type==="PropertyValue"),n=Array.isArray(e.fields)&&e.fields.length>0?e.fields.map(r=>({name:r.name??"",value:r.value??"",verified_at:r.verifiedAt??null})):t.map(r=>({name:r.name??"",value:r.value??"",verified_at:null})),o=e.icon?.url??e.avatar??"",i=e.image?.url??e.header??"",s=e.webfinger??e.acct??(e.domain&&e.username?`${e.username}@${e.domain}`:void 0)??e.preferredUsername??e.username??e.id,c=typeof e.statusesCount=="number"?e.statusesCount:N(e.outbox);return{id:e.id,username:e.preferredUsername??e.username??e.id,acct:s,display_name:e.name??e.displayName??e.preferredUsername??e.username??"",locked:e.manuallyApprovesFollowers??e.locked??!1,bot:e.type==="Service"||e.bot===!0,discoverable:e.discoverable??!0,group:e.type==="Group",created_at:e.published??e.createdAt??new Date().toISOString(),note:e.summary??"",url:e.url??e.id,avatar:o,avatar_static:o,header:i,header_static:i,followers_count:N(e.followers),following_count:N(e.following),statuses_count:c,last_status_at:null,emojis:[],fields:n}}function N(e){return typeof e=="number"?e:e?.totalCount??0}const x={IMAGE:"image",VIDEO:"video",AUDIO:"audio",GIFV:"gifv",DOCUMENT:"unknown",UNKNOWN:"unknown"};function Z(e,t=void 0){if(!e)return{id:"",type:"unknown",url:"",preview_url:"",remote_url:null,description:null,blurhash:null,meta:t?.length?{warnings:[...t]}:void 0};const n=e,o=n.preview_url??void 0,i=n.remote_url??void 0,s=n.text_url??void 0,c=n.spoiler_text??void 0,r=typeof e.url=="string"?e.url:"",q=(typeof e.previewUrl=="string"&&e.previewUrl.length>0?e.previewUrl:o)||r,D=j(e.mediaCategory??e.type,e.mimeType),H=x[D]??"unknown",d=typeof e.width=="number"?e.width:null,f=typeof e.height=="number"?e.height:null,S=typeof e.duration=="number"?e.duration:null,L=d!==null||f!==null||S!==null?{width:d??0,height:f??0,size:d&&f?`${d}x${f}`:void 0,aspect:d&&f?d/f:void 0,duration:S??void 0}:void 0,l={};return L&&(l.original=L),l.media_category=D,e.mimeType&&(l.mime_type=e.mimeType),typeof e.type=="string"&&(l.media_type=e.type),t&&t.length>0&&(l.warnings=[...t]),{id:typeof e.id=="string"&&e.id.length>0?e.id:r||`upload-${Date.now()}`,type:H,url:r,preview_url:q||r,remote_url:i??e.remoteUrl??(r||null),text_url:s??e.textUrl??(r||void 0),meta:Object.keys(l).length>0?l:void 0,description:e.description??null,blurhash:e.blurhash??null,sensitive:typeof e.sensitive=="boolean"?e.sensitive:void 0,spoiler_text:e.spoilerText??c??null}}function j(e,t){const n=typeof e=="string"?e.toUpperCase():null;return n&&x[n]?n:t?ee(t)??"UNKNOWN":"UNKNOWN"}function ee(e){if(!e)return null;const t=e.toLowerCase();return t.startsWith("image/")?t==="image/gif"?"GIFV":"IMAGE":t.startsWith("video/")?"VIDEO":t.startsWith("audio/")?"AUDIO":t==="application/pdf"||t==="text/plain"||t==="text/markdown"?"DOCUMENT":null}const te={ALLOWED_TAGS:["p","br","span","a","strong","em","b","i","u","s","del","blockquote","pre","code","ul","ol","li","h1","h2","h3","h4","h5","h6","mention","hashtag"],ALLOWED_ATTR:["href","rel","target","class","title","data-user","data-tag"],ADD_ATTR:["target","rel"],FORBID_TAGS:["script","style","iframe","object","embed","form"],FORBID_ATTR:["onerror","onload","onclick","onmouseover","onfocus","onblur"]},ne=/^(?:(?:(?:f|ht)tps?|mailto|tel|callto|cid|xmpp|xxx):|[^a-z]|[a-z+.\-]+(?:[^a-z+.\-:]|$))/i,oe={amp:"&",lt:"<",gt:">",quot:'"',"#x27":"'","#39":"'"},re=/&(?:amp|lt|gt|quot|#x27|#39);/gi,ie=/<[^>]*>/g;function E(e){return e.replace(re,t=>{const n=t.slice(1,-1).toLowerCase();return oe[n]??t})}function $(e){let t=e,n;do n=t,t=t.replace(ie,"");while(t!==n);return t}let u=typeof window>"u"?m:null,M=typeof window>"u"?Promise.resolve(m):null;typeof window<"u"&&I();function O(e){return e!==null&&e!==!1}function I(){typeof window>"u"||M||(u=m,M=Promise.resolve(m))}function ae(){return O(u)?u:m}function U(e,t,n){const o=E(t);return e.sanitize(o,{...n,KEEP_CONTENT:!0})}function se(e){if(typeof document>"u")return e;const t=document.createElement("div");return t.innerHTML=e,t.querySelectorAll("a").forEach(n=>{n.setAttribute("target","_blank"),n.setAttribute("rel","noopener noreferrer ugc");const o=n.getAttribute("href");o&&!o.startsWith("/")&&!o.startsWith("#")&&n.classList.add("external-link")}),t.querySelectorAll(".mention").forEach(n=>{n.setAttribute("rel","noopener noreferrer ugc")}),t.innerHTML}function _e(e){if(!e)return"";const t={...te,ALLOWED_URI_REGEXP:ne};if(typeof window>"u")return U(ae(),e,t);if(O(u)){const n=U(u,e,t);return se(n)}return I(),$(E(e))}function y(e){if(!e)return"";const t=E(e),n=O(u)?u:typeof window>"u"?m:null;return n?n.sanitize(t,{ALLOWED_TAGS:[],ALLOWED_ATTR:[],KEEP_CONTENT:!0}):(I(),$(t))}const k=()=>typeof window<"u"&&typeof window.Notification=="function",a=Q({}),w=g(!1),A=g(null),T=g(!0),v=g(null),F=g("all"),le=b([a],e=>Object.values(e).length),ue=b([a,F],(e,t)=>{let n=Object.values(e);return t!=="all"&&(n=n.filter(o=>o.type===t)),n.sort((o,i)=>new Date(i.created_at).getTime()-new Date(o.created_at).getTime())}),ce=b([a],e=>{const t={all:0,mention:0,status:0,reblog:0,follow:0,follow_request:0,favourite:0,poll:0,update:0,"admin.sign_up":0,"admin.report":0};return Object.values(e).forEach(n=>{t.all++;const o=n.type;t[o]!==void 0&&t[o]++}),t});function R(e){const t=e.notification||e,o={MENTION:"mention",LIKE:"favourite",SHARE:"reblog",FOLLOW:"follow",FOLLOW_REQUEST:"follow_request",POLL:"poll",STATUS:"status",UPDATE:"update",ADMIN_SIGN_UP:"admin.sign_up",ADMIN_REPORT:"admin.report"}[t.type]||"mention",i=P((t.actor||t.account)??{id:t.id}),s=t.object?G(t.object):null;return{id:t.id,type:o,created_at:t.createdAt||t.created_at||new Date().toISOString(),account:i,status:s||void 0}}function G(e){return{id:e.id,uri:e.id,url:e.id,created_at:e.published||e.createdAt||new Date().toISOString(),account:P((e.actor||e.attributedTo||e.author)??{id:e.id}),content:e.content||"",visibility:e.visibility?.toLowerCase()||"public",sensitive:e.sensitive??!1,spoiler_text:e.summary??e.spoilerText??"",media_attachments:(e.attachments||[]).map(t=>Z(t)),mentions:[],tags:[],emojis:[],reblogs_count:e.shares?.totalCount||e.sharesCount||0,favourites_count:e.likes?.totalCount||e.likesCount||0,replies_count:e.replies?.totalCount||e.repliesCount||0,reblogged:X(e),favourited:V(e),bookmarked:Y(e),pinned:J(e),reblog:e.shareOf?G(e.shareOf):null,in_reply_to_id:e.inReplyTo?.id||null,in_reply_to_account_id:null,application:null,language:e.language||null,muted:!1,poll:null,card:null,edited_at:e.updated||null}}async function de(e=!1){if(!w.get()){w.set(!0),A.set(null);try{const t=await h(),n={first:20,after:e?void 0:v.get()},o=await t.fetchNotifications(n),i=(o?.edges||[]).map(r=>R(r.node)),s=o?.pageInfo;s?.hasNextPage||T.set(!1),s?.endCursor&&v.set(s.endCursor);const c=e?{}:{...a.get()};i.forEach(r=>{c[r.id]=r}),a.set(c)}catch(t){console.error("[Notifications] Error loading notifications:",t),A.set(t instanceof Error?t.message:"Failed to load notifications")}finally{w.set(!1)}}}async function fe(){try{await(await h()).clearNotifications(),a.set({}),v.set(null),T.set(!0)}catch(e){console.error("Failed to clear all notifications:",e)}}async function W(e){try{await(await h()).dismissNotification(e);const n={...a.get()};delete n[e],a.set(n)}catch(t){console.error("Failed to dismiss notification:",t)}}let p=null;async function z(){if(p||!K.currentUser)return;p=(await h()).subscribeToNotificationStream().subscribe({next:t=>{try{const n=t.data?.notificationStream;if(!n)return;switch(n.type){case"NEW":if(n.notification){const o=R(n.notification);a.set({...a.get(),[o.id]:o}),k()&&window.Notification.permission==="granted"&&pe(o)}break;case"DELETE":n.notificationId&&W(n.notificationId);break}}catch(n){console.error("Failed to parse notification event:",n)}},error:t=>{console.error("Notification stream error:",t),C(),setTimeout(()=>z(),5e3)},complete:()=>{B("Notification stream closed"),p=null}})}function C(){p&&(p.unsubscribe(),p=null)}function pe(e){if(!k())return;let t="",n="",o=e.account?.avatar;switch(e.type){case"mention":t=`${e.account.display_name||e.account.username} mentioned you`,n=e.status?.content?y(e.status.content):"";break;case"reblog":t=`${e.account.display_name||e.account.username} boosted your post`,n=e.status?.content?y(e.status.content):"";break;case"favourite":t=`${e.account.display_name||e.account.username} favorited your post`,n=e.status?.content?y(e.status.content):"";break;case"follow":t=`${e.account.display_name||e.account.username} followed you`,n=`@${e.account.acct}`;break;case"follow_request":t=`${e.account.display_name||e.account.username} requested to follow you`,n=`@${e.account.acct}`;break;case"poll":t="A poll you voted in has ended",n=e.status?.content?y(e.status.content):"";break;case"update":t="A post you interacted with was edited",n=e.status?.content?y(e.status.content):"";break}t&&new window.Notification(t,{body:n.length>100?n.substring(0,100)+"...":n,icon:o,tag:e.id,data:{notificationId:e.id}})}async function me(){return k()&&window.Notification.permission==="default"?await window.Notification.requestPermission()==="granted":!1}function ge(){C(),a.set({}),v.set(null),T.set(!0)}const Te=Object.freeze(Object.defineProperty({__proto__:null,cleanupNotifications:ge,clearAllNotifications:fe,dismissNotification:W,endCursor$:v,filteredNotifications$:ue,hasMoreNotifications$:T,isLoadingNotifications$:w,loadNotifications:de,notificationCounts$:ce,notificationFilter$:F,notifications$:a,notificationsError$:A,requestNotificationPermission:me,startNotificationStream:z,stopNotificationStream:C,unreadCount$:le},Symbol.toStringTag,{value:"Module"}));export{Y as a,V as b,X as c,Z as d,_e as e,P as m,Te as n,J as r,z as s,le as u};
