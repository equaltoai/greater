const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./Ba6e7e3c.js","./CR55hjPZ.js","./BwIUDySL.js"])))=>i.map(i=>d[i]);
import{R as V,j,aC as z,k as _,a9 as B,aa as H,ak as O,a0 as $,_ as L,U as K,g as l,h as d,f as p,A as M}from"./Bpv4puWN.js";import{_ as W}from"./_LYS6rzG.js";function dt(s,t){let e=null,r=_;var n;if(_){e=K;for(var a=B(document.head);a!==null&&(a.nodeType!==H||a.data!==s);)a=O(a);if(a===null)$(!1);else{var o=O(a);a.remove(),L(o)}}_||(n=document.head.appendChild(V()));try{j(()=>t(n),z)}finally{r&&($(!0),L(e))}}const F="greater_auth_",I=`${F}apps`,A=`${F}tokens`;async function w(){const s=`${navigator.userAgent}_${screen.width}x${screen.height}`,e=new TextEncoder().encode(s),r=await crypto.subtle.digest("SHA-256",e);return btoa(String.fromCharCode(...new Uint8Array(r)))}function U(s,t){const e=Array.from(s).map((r,n)=>String.fromCharCode(r.charCodeAt(0)^t.charCodeAt(n%t.length))).join("");return btoa(e)}function x(s,t){const e=atob(s);return Array.from(e).map((r,n)=>String.fromCharCode(r.charCodeAt(0)^t.charCodeAt(n%t.length))).join("")}async function Y(s,t){try{const e=await w(),r=await D();r[s]=t;const n=U(JSON.stringify(r),e);localStorage.setItem(I,n)}catch(e){throw console.error("[Browser Storage] Failed to store app:",e),e}}async function G(s){try{return(await D())[s]||null}catch(t){return console.error("[Browser Storage] Failed to get app:",t),null}}async function D(){try{const s=localStorage.getItem(I);if(!s)return{};const t=await w(),e=x(s,t);return JSON.parse(e)}catch(s){return console.error("[Browser Storage] Failed to parse apps:",s),{}}}async function X(s,t){try{const e=await w(),r=await v();r[s]=t;const n=U(JSON.stringify(r),e);localStorage.setItem(A,n)}catch(e){throw console.error("[Browser Storage] Failed to store token:",e),e}}async function q(s){try{return(await v())[s]||null}catch(t){return console.error("[Browser Storage] Failed to get token:",t),null}}async function v(){try{const s=localStorage.getItem(A);if(!s)return{};const t=await w(),e=x(s,t);return JSON.parse(e)}catch(s){return console.error("[Browser Storage] Failed to parse tokens:",s),{}}}async function Q(s){try{const t=await w(),e=await v();delete e[s];const r=U(JSON.stringify(e),t);localStorage.setItem(A,r)}catch(t){console.error("[Browser Storage] Failed to revoke token:",t)}}function Z(){localStorage.removeItem(I),localStorage.removeItem(A)}class f{static instance;tokenCache=new Map;CACHE_TTL=300*1e3;constructor(){}static getInstance(){return f.instance||(f.instance=new f),f.instance}async storeApp(t,e){await Y(t,e)}async getApp(t){return await G(t)}async storeToken(t,e){await X(t,e),this.tokenCache.delete(t)}async getToken(t){const e=this.tokenCache.get(t);if(e&&e.expires>Date.now())return e.token;const r=await q(t);return r&&this.tokenCache.set(t,{token:r,expires:Date.now()+this.CACHE_TTL}),r}async revokeToken(t){await Q(t),this.tokenCache.delete(t)}async checkSession(t){return await this.getToken(t)!==null}clearAll(){Z(),this.tokenCache.clear()}}const c=f.getInstance(),tt=typeof import.meta<"u"&&!1||!1;function u(s,...t){tt&&console.warn(s,...t)}const P="read write follow push";function k(){return typeof window<"u"?`${window.location.origin}/auth/callback`:"http://localhost:4321/auth/callback"}function R(s){const t=new Uint8Array(s);return crypto.getRandomValues(t),Array.from(t,e=>e.toString(16).padStart(2,"0")).join("")}function et(){return R(64)}async function rt(s){const e=new TextEncoder().encode(s),r=await crypto.subtle.digest("SHA-256",e);return btoa(String.fromCharCode(...new Uint8Array(r))).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}async function nt(s){const t=g(s),e=new URLSearchParams({client_name:"Greater",redirect_uris:k(),scopes:P,website:"https://greater.website"}),r=await fetch(`${t}/api/v1/apps`,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:e.toString()});if(!r.ok){const a=await r.text();throw new Error(`Failed to register app: ${a}`)}const n=await r.json();return await c.storeApp(t,n),n}async function J(s){const t=g(s),e=k(),r=`app_${t}_${e}`,n=sessionStorage.getItem(r);if(n)try{const i=JSON.parse(n);return u("[OAuth] Using stored app for",t),i}catch(i){console.error("[OAuth] Failed to parse stored app:",i),sessionStorage.removeItem(r)}Object.keys(sessionStorage).forEach(i=>{i.startsWith(`app_${t}_`)&&i!==r&&(u("[OAuth] Removing old app registration:",i),sessionStorage.removeItem(i))}),u("[OAuth] Registering new app for",t,"with redirect URI:",e);const o=await nt(s);return sessionStorage.setItem(r,JSON.stringify(o)),o}async function st(s){const t=g(s.instance),e=await J(s.instance),r=et(),n=await rt(r),a=R(32);sessionStorage.setItem(`oauth_state_${a}`,JSON.stringify({instance:t,codeVerifier:r,timestamp:Date.now(),appId:e.client_id,appName:e.name}));const o=new URLSearchParams({client_id:e.client_id,response_type:"code",redirect_uri:k(),scope:s.scopes?.join(" ")||P,code_challenge:n,code_challenge_method:"S256",state:a});return s.force&&o.append("force_login","true"),{url:`${t}/oauth/authorize?${o.toString()}`,codeVerifier:r,state:a}}async function at(s){const t=g(s.instance),e=await J(s.instance),r=new URLSearchParams({client_id:e.client_id,client_secret:e.client_secret,redirect_uri:k(),grant_type:"authorization_code",code:s.code,code_verifier:s.codeVerifier}),n=await fetch(`${t}/oauth/token`,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:r.toString()});if(!n.ok){const o=await n.text();throw new Error(`Failed to exchange code for token: ${o}`)}return await n.json()}async function N(s,t){const e=g(s);let r=null;const n=sessionStorage.getItem(`app_${e}`);if(n&&(r=JSON.parse(n)),!r)return;const a=new URLSearchParams({client_id:r.client_id,client_secret:r.client_secret,token:t});(await fetch(`${e}/oauth/revoke`,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:a.toString()})).ok}function g(s){let t=s.trim().toLowerCase();return t=t.replace(/^https?:\/\//,""),t=t.replace(/\/$/,""),`https://${t}`}async function b(s){try{const t=g(s);return(await fetch(`${t}/api/v1/instance`)).ok}catch{return!1}}class m extends Error{constructor(t,e,r){super(t),this.code=e,this.instance=r,this.name="AuthError"}}class ot{#t=l(null);get currentUser(){return d(this.#t)}set currentUser(t){p(this.#t,t,!0)}#e=l(null);get currentInstance(){return d(this.#e)}set currentInstance(t){p(this.#e,t,!0)}#r=l(M([]));get accounts(){return d(this.#r)}set accounts(t){p(this.#r,t,!0)}#n=l(!1);get isAuthenticated(){return d(this.#n)}set isAuthenticated(t){p(this.#n,t,!0)}#s=l(!1);get isLoading(){return d(this.#s)}set isLoading(t){p(this.#s,t,!0)}#a=l(null);get error(){return d(this.#a)}set error(t){p(this.#a,t,!0)}_initialized=!1;constructor(){}persist(){if(typeof window>"u")return;const t={state:{accounts:this.accounts.map(e=>({id:e.id,instance:e.instance,user:e.user,lastUsed:e.lastUsed,token:{},app:{}})),currentUser:this.currentUser,currentInstance:this.currentInstance,isAuthenticated:this.isAuthenticated}};localStorage.setItem("auth-storage",JSON.stringify(t))}initialize(){if(typeof window>"u"||this._initialized)return;this._initialized=!0;const t=localStorage.getItem("auth-storage");if(t)try{const e=JSON.parse(t);e.state&&(this.currentUser=e.state.currentUser,this.currentInstance=e.state.currentInstance,this.accounts=e.state.accounts||[],this.isAuthenticated=!!(e.state.currentUser&&e.state.currentInstance),this.isAuthenticated&&this.currentInstance&&this.refreshCurrentUser().catch(r=>{console.error("[Auth] Failed to refresh user on init:",r),this.isAuthenticated=!1,this.currentUser=null,this.persist()}))}catch(e){console.error("[Auth] Failed to load auth state:",e),this.isAuthenticated=!1,localStorage.removeItem("auth-storage")}else this.isAuthenticated=!1,this.currentUser=null,this.currentInstance=null,this.accounts=[]}async startLogin(t){this.isLoading=!0,this.error=null;try{if(!await b(t))throw new m("Invalid instance URL","INVALID_INSTANCE",t);const{url:r,state:n}=await st({instance:t});return this.isLoading=!1,{url:r,state:n}}catch(e){const r=e instanceof Error?e.message:"Login failed";throw this.isLoading=!1,this.error=r,e}}async completeLogin(t,e){this.isLoading=!0,this.error=null;try{const r=sessionStorage.getItem(`oauth_state_${e}`);if(!r)throw new m("Invalid or expired state","INVALID_STATE");const{instance:n,codeVerifier:a}=JSON.parse(r);sessionStorage.removeItem(`oauth_state_${e}`);const o=await at({instance:n,code:t,codeVerifier:a}),i=await it(n,o.access_token);let y=null,S=null;const C=Object.keys(sessionStorage);for(const h of C)if(h.startsWith(`app_${n}_`)){y=sessionStorage.getItem(h),S=h;break}y||(console.error("[Auth] No app data found for instance:",n),console.error("[Auth] Available keys:",C.filter(h=>h.startsWith("app_"))));let T=null;if(y)try{T=JSON.parse(y),await c.storeApp(n,T),S&&sessionStorage.removeItem(S)}catch(h){console.error("[Auth] Failed to parse app data:",h)}await c.storeToken(n,o);const E={id:`${n}:${i.id}`,instance:n,user:i,token:{},app:{},lastUsed:Date.now()};this.currentUser=i,this.currentInstance=n,this.accounts=[...this.accounts.filter(h=>h.id!==E.id),E],this.isAuthenticated=!0,this.isLoading=!1,this.error=null,this.persist()}catch(r){const n=r instanceof Error?r.message:"Login failed";throw this.isLoading=!1,this.error=n,r}}async logout(){if(!this.currentInstance||!this.currentUser)return;this.isLoading=!0;const{cleanupNotifications:t}=await W(async()=>{const{cleanupNotifications:e}=await import("./Ba6e7e3c.js").then(r=>r.n);return{cleanupNotifications:e}},__vite__mapDeps([0,1,2]),import.meta.url);t();try{const e=this.accounts.find(r=>r.instance===this.currentInstance&&r.user.id===this.currentUser?.id);if(e){const r=await c.getToken(e.instance);r&&(await N(e.instance,r.access_token),await c.revokeToken(e.instance));const n=this.accounts.filter(o=>o.id!==e.id),a=n[0];this.currentUser=a?.user||null,this.currentInstance=a?.instance||null,this.accounts=n,this.isAuthenticated=!!a,this.isLoading=!1,this.persist()}}catch{this.currentUser=null,this.currentInstance=null,this.accounts=[],this.isAuthenticated=!1,this.isLoading=!1,this.persist()}}async switchAccount(t){const e=this.accounts.find(r=>r.id===t);if(e){if(!await c.getToken(e.instance))throw await this.removeAccount(t),new m("Session expired","SESSION_EXPIRED");e.lastUsed=Date.now(),this.currentUser=e.user,this.currentInstance=e.instance,this.accounts=this.accounts.map(n=>n.id===t?{...n,lastUsed:Date.now()}:n)}}async removeAccount(t){const e=this.accounts.find(n=>n.id===t);if(!e)return;try{const n=await c.getToken(e.instance);n&&(await N(e.instance,n.access_token),await c.revokeToken(e.instance))}catch{}const r=this.accounts.filter(n=>n.id!==t);if(e.user.id===this.currentUser?.id){const n=r[0];this.currentUser=n?.user||null,this.currentInstance=n?.instance||null,this.accounts=r,this.isAuthenticated=!!n}else this.accounts=r}async validateInstanceUrl(t){return b(t)}setError(t){this.error=t}clearError(){this.error=null}async restoreSession(){if(!(!this.currentInstance||!this.isAuthenticated))try{await c.hasValidSession()||(this.currentUser=null,this.currentInstance=null,this.accounts=[],this.isAuthenticated=!1)}catch{}}updateAccount(t){this.currentUser=t,this.accounts=this.accounts.map(e=>e.user.id===t.id&&e.instance===this.currentInstance?{...e,user:t}:e),this.persist()}async refreshCurrentUser(){if(!(!this.currentInstance||!this.isAuthenticated))try{const t=await fetch(`${this.currentInstance}/api/v1/accounts/verify_credentials`,{headers:{Authorization:`Bearer ${await ut()}`}});if(!t.ok)throw new Error("Failed to fetch user data");const e=await t.json();u("[Auth] Fresh user data from API:",e),u("[Auth] Avatar URL from API:",e.avatar);const r=e.user||e;!r.acct&&r.username&&(r.acct=r.username),u("[Auth] Account data to use:",r),u("[Auth] Account username:",r.username),u("[Auth] Account acct:",r.acct),this.updateAccount(r),u("[Auth] Current user after update:",this.currentUser),u("[Auth] Avatar after update:",this.currentUser?.avatar)}catch(t){console.error("[Auth] Failed to refresh current user:",t)}}}async function it(s,t){const e=await fetch(`${s}/api/v1/accounts/verify_credentials`,{headers:{Authorization:`Bearer ${t}`}});if(!e.ok)throw new m("Failed to verify credentials","VERIFY_FAILED",s);const r=await e.json(),n=r.user||r;return!n.acct&&n.username&&(n.acct=n.username),n}const ct=new ot;async function ut(){const{currentInstance:s}=ct;if(!s)return null;try{return(await c.getToken(s))?.access_token||null}catch{return null}}export{ct as a,dt as h,u as l,c as s};
