const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./BdV_69hN.js","./D3HftPX2.js","./DIpZa-rG.js","./DQIc1P_2.js"])))=>i.map(i=>d[i]);
import{L as K,aA as Y,aB as W,c as G,b as X,aC as q,j as b,x as Z,G as Q,t as F,D as x,d as D,F as tt,a5 as et,a6 as rt,aD as nt,T as g,X as w,g as y,Z as A,aj as st,W as h,Y as i}from"./DIpZa-rG.js";import{_ as at}from"./sirv-2-2.js";var ot="font-weight: bold",it="font-weight: normal";function P(n){console.warn(`%c[svelte] state_snapshot_uncloneable
%c${n?`The following properties cannot be cloned with \`$state.snapshot\` — the return value contains the originals:

${n}`:"Value cannot be cloned with `$state.snapshot` — the original value was returned"}
https://svelte.dev/e/state_snapshot_uncloneable`,ot,it)}const ct=[];function ut(n,t=!1,e=!1){if(!t){const r=[],s=I(n,new Map,"",r,null,e);if(r.length===1&&r[0]==="")P();else if(r.length>0){const a=r.length>10?r.slice(0,7):r.slice(0,10),c=r.length-a.length;let o=a.map(u=>`- <value>${u}`).join(`
`);c>0&&(o+=`
- ...and ${c} more`),P(o)}return s}return I(n,new Map,"",ct,null,e)}function I(n,t,e,r,s=null,a=!1){if(typeof n=="object"&&n!==null){var c=t.get(n);if(c!==void 0)return c;if(n instanceof Map)return new Map(n);if(n instanceof Set)return new Set(n);if(K(n)){var o=Array(n.length);t.set(n,o),s!==null&&t.set(s,o);for(var u=0;u<n.length;u+=1){var k=n[u];u in n&&(o[u]=I(k,t,`${e}[${u}]`,r,null,a))}return o}if(Y(n)===W){o={},t.set(n,o),s!==null&&t.set(s,o);for(var p in n)o[p]=I(n[p],t,`${e}.${p}`,r,null,a);return o}if(n instanceof Date)return structuredClone(n);if(typeof n.toJSON=="function"&&!a)return I(n.toJSON(),t,`${e}.toJSON()`,r,n)}if(n instanceof EventTarget)return n;try{return structuredClone(n)}catch{return r.push(e),n}}function $t(n,t){let e=null,r=b;var s;if(b){e=tt;for(var a=Z(document.head);a!==null&&(a.nodeType!==Q||a.data!==n);)a=F(a);if(a===null)x(!1);else{var c=F(a);a.remove(),D(c)}}b||(s=document.head.appendChild(G()));try{X(()=>t(s),q)}finally{r&&(x(!0),D(e))}}function m(n,...t){return et(()=>{try{let e=!1;const r=[];for(const s of t)s&&typeof s=="object"&&rt in s?(r.push(ut(s,!0)),e=!0):r.push(s);e&&(nt(n),console.log("%c[snapshot]","color: grey",...r))}catch{}}),t}const j="greater_auth_",O=`${j}apps`,C=`${j}tokens`;async function U(){const n=`${navigator.userAgent}_${screen.width}x${screen.height}`,e=new TextEncoder().encode(n),r=await crypto.subtle.digest("SHA-256",e);return btoa(String.fromCharCode(...new Uint8Array(r)))}function v(n,t){const e=Array.from(n).map((r,s)=>String.fromCharCode(r.charCodeAt(0)^t.charCodeAt(s%t.length))).join("");return btoa(e)}function V(n,t){const e=atob(n);return Array.from(e).map((r,s)=>String.fromCharCode(r.charCodeAt(0)^t.charCodeAt(s%t.length))).join("")}async function ht(n,t){try{const e=await U(),r=await B();r[n]=t;const s=v(JSON.stringify(r),e);localStorage.setItem(O,s)}catch(e){throw console.error("[Browser Storage] Failed to store app:",e),e}}async function lt(n){try{return(await B())[n]||null}catch(t){return console.error("[Browser Storage] Failed to get app:",t),null}}async function B(){try{const n=localStorage.getItem(O);if(!n)return{};const t=await U(),e=V(n,t);return JSON.parse(e)}catch(n){return console.error("[Browser Storage] Failed to parse apps:",n),{}}}async function dt(n,t){try{const e=await U(),r=await L();r[n]=t;const s=v(JSON.stringify(r),e);localStorage.setItem(C,s)}catch(e){throw console.error("[Browser Storage] Failed to store token:",e),e}}async function ft(n){try{return(await L())[n]||null}catch(t){return console.error("[Browser Storage] Failed to get token:",t),null}}async function L(){try{const n=localStorage.getItem(C);if(!n)return{};const t=await U(),e=V(n,t);return JSON.parse(e)}catch(n){return console.error("[Browser Storage] Failed to parse tokens:",n),{}}}async function pt(n){try{const t=await U(),e=await L();delete e[n];const r=v(JSON.stringify(e),t);localStorage.setItem(C,r)}catch(t){console.error("[Browser Storage] Failed to revoke token:",t)}}function gt(){localStorage.removeItem(O),localStorage.removeItem(C)}class S{static instance;tokenCache=new Map;CACHE_TTL=300*1e3;constructor(){}static getInstance(){return S.instance||(S.instance=new S),S.instance}async storeApp(t,e){await ht(t,e)}async getApp(t){return await lt(t)}async storeToken(t,e){await dt(t,e),this.tokenCache.delete(t)}async getToken(t){const e=this.tokenCache.get(t);if(e&&e.expires>Date.now())return e.token;const r=await ft(t);return r&&this.tokenCache.set(t,{token:r,expires:Date.now()+this.CACHE_TTL}),r}async revokeToken(t){await pt(t),this.tokenCache.delete(t)}async checkSession(t){return await this.getToken(t)!==null}clearAll(){gt(),this.tokenCache.clear()}}const l=S.getInstance();function d(n,...t){console.warn(n,...t)}const z="read write follow push";function $(){return typeof window<"u"?`${window.location.origin}/auth/callback`:"http://localhost:4321/auth/callback"}function M(n){const t=new Uint8Array(n);return crypto.getRandomValues(t),Array.from(t,e=>e.toString(16).padStart(2,"0")).join("")}function wt(){return M(64)}async function yt(n){const e=new TextEncoder().encode(n),r=await crypto.subtle.digest("SHA-256",e);return btoa(String.fromCharCode(...new Uint8Array(r))).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}async function At(n){const t=_(n),e=new URLSearchParams({client_name:"Greater",redirect_uris:$(),scopes:z,website:"https://greater.website"}),r=await fetch(`${t}/api/v1/apps`,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:e.toString()});if(!r.ok){const a=await r.text();throw new Error(`Failed to register app: ${a}`)}const s=await r.json();return await l.storeApp(t,s),s}async function H(n){const t=_(n),e=$(),r=`app_${t}_${e}`,s=sessionStorage.getItem(r);if(s)try{const o=JSON.parse(s);return d("[OAuth] Using stored app for",t),o}catch(o){console.error("[OAuth] Failed to parse stored app:",o),sessionStorage.removeItem(r)}Object.keys(sessionStorage).forEach(o=>{o.startsWith(`app_${t}_`)&&o!==r&&(d("[OAuth] Removing old app registration:",o),sessionStorage.removeItem(o))}),d("[OAuth] Registering new app for",t,"with redirect URI:",e);const c=await At(n);return sessionStorage.setItem(r,JSON.stringify(c)),c}async function mt(n){const t=_(n.instance),e=await H(n.instance),r=wt(),s=await yt(r),a=M(32);sessionStorage.setItem(`oauth_state_${a}`,JSON.stringify({instance:t,codeVerifier:r,timestamp:Date.now(),appId:e.client_id,appName:e.name}));const c=new URLSearchParams({client_id:e.client_id,response_type:"code",redirect_uri:$(),scope:n.scopes?.join(" ")||z,code_challenge:s,code_challenge_method:"S256",state:a});return n.force&&c.append("force_login","true"),{url:`${t}/oauth/authorize?${c.toString()}`,codeVerifier:r,state:a}}async function St(n){const t=_(n.instance),e=await H(n.instance),r=new URLSearchParams({client_id:e.client_id,client_secret:e.client_secret,redirect_uri:$(),grant_type:"authorization_code",code:n.code,code_verifier:n.codeVerifier}),s=await fetch(`${t}/oauth/token`,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:r.toString()});if(!s.ok){const c=await s.text();throw new Error(`Failed to exchange code for token: ${c}`)}return await s.json()}async function R(n,t){const e=_(n);let r=null;const s=sessionStorage.getItem(`app_${e}`);if(s&&(r=JSON.parse(s)),!r)return;const a=new URLSearchParams({client_id:r.client_id,client_secret:r.client_secret,token:t});(await fetch(`${e}/oauth/revoke`,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:a.toString()})).ok}function _(n){let t=n.trim().toLowerCase();return t=t.replace(/^https?:\/\//,""),t=t.replace(/\/$/,""),`https://${t}`}async function J(n){try{const t=_(n);return(await fetch(`${t}/api/v1/instance`)).ok}catch{return!1}}class T extends Error{constructor(t,e,r){super(t),this.code=e,this.instance=r,this.name="AuthError"}}class _t{#t=g(w(null),"AuthStore.currentUser");get currentUser(){return y(this.#t)}set currentUser(t){A(this.#t,t,!0)}#e=g(w(null),"AuthStore.currentInstance");get currentInstance(){return y(this.#e)}set currentInstance(t){A(this.#e,t,!0)}#r=g(w(st([])),"AuthStore.accounts");get accounts(){return y(this.#r)}set accounts(t){A(this.#r,t,!0)}#n=g(w(!1),"AuthStore.isAuthenticated");get isAuthenticated(){return y(this.#n)}set isAuthenticated(t){A(this.#n,t,!0)}#s=g(w(!1),"AuthStore.isLoading");get isLoading(){return y(this.#s)}set isLoading(t){A(this.#s,t,!0)}#a=g(w(null),"AuthStore.error");get error(){return y(this.#a)}set error(t){A(this.#a,t,!0)}_initialized=!1;constructor(){}persist(){if(h(typeof window,"undefined"))return;const t={state:{accounts:this.accounts.map(e=>({id:e.id,instance:e.instance,user:e.user,lastUsed:e.lastUsed,token:{},app:{}})),currentUser:this.currentUser,currentInstance:this.currentInstance,isAuthenticated:this.isAuthenticated}};localStorage.setItem("auth-storage",JSON.stringify(t))}initialize(){if(h(typeof window,"undefined")||this._initialized)return;this._initialized=!0;const t=localStorage.getItem("auth-storage");if(t)try{const e=JSON.parse(t);e.state&&(this.currentUser=e.state.currentUser,this.currentInstance=e.state.currentInstance,this.accounts=e.state.accounts||[],this.isAuthenticated=!!(e.state.currentUser&&e.state.currentInstance),this.isAuthenticated&&this.currentInstance&&this.refreshCurrentUser().catch(r=>{console.error(...m("error","[Auth] Failed to refresh user on init:",r)),this.isAuthenticated=!1,this.currentUser=null,this.persist()}))}catch(e){console.error(...m("error","[Auth] Failed to load auth state:",e)),this.isAuthenticated=!1,localStorage.removeItem("auth-storage")}else this.isAuthenticated=!1,this.currentUser=null,this.currentInstance=null,this.accounts=[]}async startLogin(t){this.isLoading=!0,this.error=null;try{if(!(await i(J(t)))())throw new T("Invalid instance URL","INVALID_INSTANCE",t);const{url:r,state:s}=(await i(mt({instance:t})))();return this.isLoading=!1,{url:r,state:s}}catch(e){const r=e instanceof Error?e.message:"Login failed";throw this.isLoading=!1,this.error=r,e}}async completeLogin(t,e){this.isLoading=!0,this.error=null;try{const r=sessionStorage.getItem(`oauth_state_${e}`);if(!r)throw new T("Invalid or expired state","INVALID_STATE");const{instance:s,codeVerifier:a}=JSON.parse(r);sessionStorage.removeItem(`oauth_state_${e}`);const c=(await i(St({instance:s,code:t,codeVerifier:a})))(),o=(await i(kt(s,c.access_token)))();let u=null,k=null;const p=Object.keys(sessionStorage);for(const f of p)if(f.startsWith(`app_${s}_`)){u=sessionStorage.getItem(f),k=f;break}u||(console.error(...m("error","[Auth] No app data found for instance:",s)),console.error(...m("error","[Auth] Available keys:",p.filter(f=>f.startsWith("app_")))));let E=null;if(u)try{E=JSON.parse(u),(await i(l.storeApp(s,E)))(),k&&sessionStorage.removeItem(k)}catch(f){console.error(...m("error","[Auth] Failed to parse app data:",f))}(await i(l.storeToken(s,c)))();const N={id:`${s}:${o.id}`,instance:s,user:o,token:{},app:{},lastUsed:Date.now()};this.currentUser=o,this.currentInstance=s,this.accounts=[...this.accounts.filter(f=>h(f.id,N.id,!1)),N],this.isAuthenticated=!0,this.isLoading=!1,this.error=null,this.persist()}catch(r){const s=r instanceof Error?r.message:"Login failed";throw this.isLoading=!1,this.error=s,r}}async logout(){if(!this.currentInstance||!this.currentUser)return;this.isLoading=!0;const{cleanupNotifications:t}=(await i(at(()=>import("./BdV_69hN.js").then(e=>e.n),__vite__mapDeps([0,1,2,3]),import.meta.url)))();t();try{const e=this.accounts.find(r=>h(r.instance,this.currentInstance)&&h(r.user.id,this.currentUser?.id));if(e){const r=(await i(l.getToken(e.instance)))();r&&((await i(R(e.instance,r.access_token)))(),(await i(l.revokeToken(e.instance)))());const s=this.accounts.filter(c=>h(c.id,e.id,!1)),a=s[0];this.currentUser=a?.user||null,this.currentInstance=a?.instance||null,this.accounts=s,this.isAuthenticated=!!a,this.isLoading=!1,this.persist()}}catch{this.currentUser=null,this.currentInstance=null,this.accounts=[],this.isAuthenticated=!1,this.isLoading=!1,this.persist()}}async switchAccount(t){const e=this.accounts.find(r=>h(r.id,t));if(e){if(!(await i(l.getToken(e.instance)))())throw(await i(this.removeAccount(t)))(),new T("Session expired","SESSION_EXPIRED");e.lastUsed=Date.now(),this.currentUser=e.user,this.currentInstance=e.instance,this.accounts=this.accounts.map(s=>h(s.id,t)?{...s,lastUsed:Date.now()}:s)}}async removeAccount(t){const e=this.accounts.find(s=>h(s.id,t));if(!e)return;try{const s=(await i(l.getToken(e.instance)))();s&&((await i(R(e.instance,s.access_token)))(),(await i(l.revokeToken(e.instance)))())}catch{}const r=this.accounts.filter(s=>h(s.id,t,!1));if(h(e.user.id,this.currentUser?.id)){const s=r[0];this.currentUser=s?.user||null,this.currentInstance=s?.instance||null,this.accounts=r,this.isAuthenticated=!!s}else this.accounts=r}async validateInstanceUrl(t){return J(t)}setError(t){this.error=t}clearError(){this.error=null}async restoreSession(){if(!(!this.currentInstance||!this.isAuthenticated))try{(await i(l.hasValidSession()))()||(this.currentUser=null,this.currentInstance=null,this.accounts=[],this.isAuthenticated=!1)}catch{}}updateAccount(t){this.currentUser=t,this.accounts=this.accounts.map(e=>h(e.user.id,t.id)&&h(e.instance,this.currentInstance)?{...e,user:t}:e),this.persist()}async refreshCurrentUser(){if(!(!this.currentInstance||!this.isAuthenticated))try{const t=(await i(fetch(`${this.currentInstance}/api/v1/accounts/verify_credentials`,{headers:{Authorization:`Bearer ${(await i(Ut()))()}`}})))();if(!t.ok)throw new Error("Failed to fetch user data");const e=(await i(t.json()))();d("[Auth] Fresh user data from API:",e),d("[Auth] Avatar URL from API:",e.avatar);const r=e.user||e;!r.acct&&r.username&&(r.acct=r.username),d("[Auth] Account data to use:",r),d("[Auth] Account username:",r.username),d("[Auth] Account acct:",r.acct),this.updateAccount(r),d("[Auth] Current user after update:",this.currentUser),d("[Auth] Avatar after update:",this.currentUser?.avatar)}catch(t){console.error(...m("error","[Auth] Failed to refresh current user:",t))}}}async function kt(n,t){const e=(await i(fetch(`${n}/api/v1/accounts/verify_credentials`,{headers:{Authorization:`Bearer ${t}`}})))();if(!e.ok)throw new T("Failed to verify credentials","VERIFY_FAILED",n);const r=(await i(e.json()))(),s=r.user||r;return!s.acct&&s.username&&(s.acct=s.username),s}const It=new _t;async function Ut(){const{currentInstance:n}=It;if(!n)return null;try{return(await i(l.getToken(n)))()?.access_token||null}catch{return null}}export{It as a,d as b,$t as h,m as l,l as s};
