---
// Home page with proper layout but simplified for debugging
import BaseLayout from '@/layouts/BaseLayout.astro';
---

<BaseLayout title="Home - Greater" description="Your home timeline">
  <div class="min-h-screen bg-background">
    <div class="max-w-2xl mx-auto px-4 py-8">
      <h1 class="text-2xl font-bold text-text mb-6">Home Timeline</h1>
      
      <div id="timeline-container">
        <div class="text-center py-8 text-text-muted">
          Loading timeline...
        </div>
      </div>
    </div>
  </div>

  <script>
    import { authStore, getAccessToken } from '@/lib/stores/auth.svelte';
    
    async function loadTimeline() {
      const container = document.getElementById('timeline-container');
      
      try {
        // Initialize auth store
        authStore.initialize();
        
        if (!authStore.isAuthenticated) {
          container.innerHTML = `
            <div class="text-center py-8">
              <p class="text-text-muted mb-4">Not authenticated</p>
              <a href="/auth/login" class="text-primary hover:underline">Login</a>
            </div>
          `;
          return;
        }
        
        const instance = authStore.currentInstance;
        const token = await getAccessToken();
        
        if (!token) {
          throw new Error('No access token available');
        }
        
        // Fetch home timeline
        const response = await fetch(`https://${instance}/api/v1/timelines/home?limit=20`, {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Accept': 'application/json'
          }
        });
        
        if (!response.ok) {
          throw new Error(`Failed to load timeline: ${response.status}`);
        }
        
        const posts = await response.json();
        
        container.innerHTML = `
          <div class="space-y-4">
            ${posts.length === 0 ? `
              <div class="text-center py-8 text-text-muted">
                No posts in your home timeline yet. Follow some people to see their posts here!
              </div>
            ` : posts.map(post => `
              <article class="bg-surface rounded-lg p-4 border border-border">
                <div class="flex items-start gap-3">
                  <img 
                    src="${post.account.avatar}" 
                    alt="${post.account.username}"
                    class="w-12 h-12 rounded-full"
                  />
                  <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-2 mb-1">
                      <strong class="text-text">${post.account.display_name || post.account.username}</strong>
                      <span class="text-text-muted text-sm">@${post.account.username}</span>
                    </div>
                    <div class="text-text prose prose-sm max-w-none">
                      ${post.content}
                    </div>
                    <div class="flex items-center gap-4 mt-3 text-text-muted text-sm">
                      <button class="hover:text-primary">
                        üí¨ ${post.replies_count}
                      </button>
                      <button class="hover:text-primary ${post.reblogged ? 'text-primary' : ''}">
                        üîÅ ${post.reblogs_count}
                      </button>
                      <button class="hover:text-primary ${post.favourited ? 'text-primary' : ''}">
                        ‚≠ê ${post.favourites_count}
                      </button>
                      <time class="ml-auto">${new Date(post.created_at).toLocaleString()}</time>
                    </div>
                  </div>
                </div>
              </article>
            `).join('')}
          </div>
        `;
        
      } catch (error) {
        console.error('Timeline error:', error);
        container.innerHTML = `
          <div class="bg-error/10 border border-error text-error rounded-lg p-4">
            <p class="font-semibold">Error loading timeline</p>
            <p class="text-sm mt-1">${error.message}</p>
            <button 
              onclick="location.reload()" 
              class="mt-3 px-4 py-2 bg-error text-white rounded hover:bg-error/90"
            >
              Retry
            </button>
          </div>
        `;
      }
    }
    
    // Load timeline when page loads
    loadTimeline();
  </script>
</BaseLayout>